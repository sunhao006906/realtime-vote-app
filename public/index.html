<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å³æ™‚èŠå¤©æŠ•ç¥¨ç³»çµ±</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; }
        #login, #main_app { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; }
        input[type="text"], .vote-btn { padding: 10px; border-radius: 4px; border: 1px solid #ccc; margin-right: 10px; }
        .vote-btn { background-color: #007bff; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        .vote-btn:hover { background-color: #0056b3; }
        #chatbox { height: 500px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; margin-top: 10px; background-color: #e9ecef; border-radius: 4px; }
        .chat-message { margin-bottom: 5px; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="login">
        <h2>ğŸ‘‹ æ­¡è¿ï¼</h2>
        <input type="text" id="username_input" placeholder="è¼¸å…¥ä½ çš„åå­—" required>
        <button class="vote-btn" onclick="login()">é€²å…¥æŠ•ç¥¨</button>
    </div>

    <div id="main_app" style="display: none;">
        
        <h2>ğŸ“Š å³æ™‚æŠ•ç¥¨çµæœ</h2>
        <p>å·¦ (A)ï¼š<strong id="vote_a_count">0</strong> ç¥¨</p>
        <p>å³ (B)ï¼š<strong id="vote_b_count">0</strong> ç¥¨</p>
        
        <h3>ğŸ—³ï¸ é€²è¡ŒæŠ•ç¥¨</h3>
        <button class="vote-btn" onclick="submitVote('optionA')">âœ… æŠ•çµ¦å·¦</button>
        <button class="vote-btn" onclick="submitVote('optionB')">âœ… æŠ•çµ¦å³</button>
        <button id="reset_btn" onclick="resetVotes()" style="background-color: #dc3545; margin-left: 20px;">ğŸ”„ é‡è¨­æŠ•ç¥¨</button>
        
        <h3>ğŸ’¬ æŠ•ç¥¨è¨˜éŒ„ (èŠå¤©å®¤)</h3>
        <div id="chatbox"></div>
    </div>

    <script>
        // 1. é€£ç·šåˆ°ä¼ºæœå™¨
        const socket = io();
        let currentUsername = '';

        // è™•ç†ç™»å…¥ï¼šéš±è—ç™»å…¥ä»‹é¢ï¼Œé¡¯ç¤ºä¸»ä»‹é¢
        function login() {
            const input = document.getElementById('username_input');
            const username = input.value.trim();
            if (username) {
                currentUsername = username;
                document.getElementById('login').style.display = 'none';
                document.getElementById('main_app').style.display = 'block';
                addChatMessage(`ğŸ‘‰ ç³»çµ±ï¼š${username} å·²åŠ å…¥æŠ•ç¥¨ã€‚`);

                // **[ä¿®æ­£]** ç™¼é€åå­—çµ¦ä¼ºæœå™¨ï¼Œä»¥ä¾¿ä¼ºæœå™¨è¨˜éŒ„èª°é€£ç·š
                socket.emit('set_username', username);
            } else {
                alert('è¼¸å…¥æœ‰æ•ˆåå­—å¥½å—?Dèƒ½');
            }
        }

        // ç™¼é€æŠ•ç¥¨çµ¦ä¼ºæœå™¨
        function submitVote(choice) {
            if (!currentUsername) {
                alert('ä¸æœƒç™»å…¥å—ï¼Ÿ');
                return;
            }
            // ä½¿ç”¨ socket.emit() å°‡è³‡æ–™ç™¼é€çµ¦å¾Œç«¯
            socket.emit('submit_vote', { username: currentUsername, choice: choice });
        }

        // **[æ–°å¢]** ç™¼é€é‡è¨­è«‹æ±‚çµ¦ä¼ºæœå™¨
        function resetVotes() {
            if (confirm("ç¢ºå®šè¦é‡è¨­æ‰€æœ‰æŠ•ç¥¨çµæœå—ï¼Ÿé€™å°‡æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ï¼")) {
                // ç™¼é€ 'reset_votes' äº‹ä»¶çµ¦ä¼ºæœå™¨
                socket.emit('reset_votes');
            }
        }

        // æ›´æ–°ä»‹é¢ä¸Šçš„ç¥¨æ•¸é¡¯ç¤º
        function updateVoteDisplay(votes) {
            document.getElementById('vote_a_count').textContent = votes.optionA;
            document.getElementById('vote_b_count').textContent = votes.optionB;
        }

        // åœ¨èŠå¤©æ¡†ä¸­æ–°å¢ä¸€æ¢è¨Šæ¯
        function addChatMessage(message) {
            const chatbox = document.getElementById('chatbox');
            const p = document.createElement('p');
            p.className = 'chat-message';
            p.textContent = message;
            chatbox.appendChild(p);
            // è®“èŠå¤©æ¡†è‡ªå‹•æ²å‹•åˆ°æœ€æ–°è¨Šæ¯
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // --- æ¥æ”¶ä¾†è‡ªä¼ºæœå™¨çš„å³æ™‚äº‹ä»¶ ---
        
        // æ¥æ”¶åˆå§‹æŠ•ç¥¨çµæœ (å‰›é€£ç·šæ™‚)
        socket.on('current_votes', (votes) => {
            updateVoteDisplay(votes);
        });

        // æ¥æ”¶æŠ•ç¥¨æ›´æ–° (æœ‰äººæŠ•ç¥¨æ™‚)
        socket.on('update_votes', (votes) => {
            updateVoteDisplay(votes);
        });

        // æ¥æ”¶èŠå¤©/æŠ•ç¥¨è¨Šæ¯
        socket.on('chat_message', (message) => {
            addChatMessage(message);
        });
    </script>
</body>
</html>